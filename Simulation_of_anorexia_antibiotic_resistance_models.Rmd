---
title: Stochastic simulation of evolution of antibiotic resistance in the face of
  anorexia
output: bookdown::html_document2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

I am considering the following very simple model of resource-dependent competition between two parasite strains, $P_1$ and $P_2$:
\begin{align}
\frac{dR}{dt} &= \theta - \chi R - \frac{\alpha_1 R}{\eta_1 + R}P_1 - \frac{\alpha_2 R}{\eta_2 + R}P_2 \\
\frac{dP_1}{dt} &= \epsilon_1 \frac{\alpha_1 R}{\eta_1 + R}P_1 - \delta_1 P_1 - \mu P_1 + \mu P_2 \\
\frac{dP_1}{dt} &= \epsilon_2 \frac{\alpha_2 R}{\eta_2 + R}P_2 - \delta_2 P_2 - \mu P_2 + \mu P_1
\end{align}

In this model, resources come into the system through "ingestion," $\theta$, and are utilized by, or lost to, the host at the per-capita rate $\chi$. 
The two parasite strains each have a Type II functional response with separate acquisition rates and half-saturation constants, $\alpha_i$ and $\eta_i$. 
Each parasite converts resources into new parasites with efficiency $\epsilon_i$, and are killed at the rate $\delta_i$.
Note that we could approximate the effect of the immune system by changing the mortality rate from a linear function to a quadratic function (e.g., if you assume that the immune response dynamics are something like $dI/dt = a (P_1+P_2) - m I$, and you assume that this attains a quasi-equilibrium [e.g., a separation of timescales argument], then $\hat{I} = a (P_2+P_2)/m$ and the parasite mortality rate would be $\delta_1 P_1 I = \delta_1 a (P_1^2 + P_1 P_2)/m$).
Finally, there is mutation between the two strains at a rate $\mu$. 

The existence of mutation implies that a deterministic model will always have both strains present.
However, if you analyze a model where $\mu = 0$, then coexistence is impossible, and the species that will win is the one that suppresses resources the most.
The resource abundance at equilibrium for either strain alone is $\hat{R} = \eta_i \delta_i/(\epsilon_i \alpha_i - \delta_i)$, so if 
\begin{equation}
\frac{\eta_1 \delta_1}{\epsilon_1 \alpha_1 - \delta_1} > \frac{\eta_2 \delta_2}{\epsilon_2 \alpha_2 - \delta_2}
\end{equation}
then strain 1 will outcompete strain 2, and vice versa if the inequality is reversed.
 
Additionally, analysis shows that, in the absence of mutation, the single strain models always go to a stable equilibrium so long as
\begin{equation}
\frac{\theta}{\chi} > \frac{\eta_i \delta_i}{(\epsilon_i \alpha_i - \delta_i)},
\end{equation}
where $\theta/\chi$ is the resource equilibrium in the absence of infection. 
Thus, if hosts drop $\theta$ enough in the presence of infection, violating the above inequality, then no parasite strains can persist at all.

As a preliminary analysis, I will do stochastic simulations of the above model assuming that parasite strain 1 can persist and outcompete strain 2 in the absence of mutation.

```{r sim1}
stochastic_strain_competition <- function(tmax, tstep, pars, y0, seed) {
  set.seed(seed)
  
  theta <- pars["theta"]
  chi <- pars["chi"]
  alpha1 <- pars["alpha1"]
  alpha2 <- pars["alpha2"]
  eta1 <- pars["eta1"]
  eta2 <- pars["eta2"]
  epsilon1 <- pars["epsilon1"]
  epsilon2 <- pars["epsilon2"]
  delta1 <- pars["delta1"]
  delta2 <- pars["delta2"]
  mu <- pars["mu"]
  
  ## initialize the time at t = 0
  t <- 0
  
  R <- y0["R"]
  P1 <- y0["P1"]
  P2 <- y0["P2"]
  
  ## initialize a dataframe to store the time and population size
  sim <- data.frame(time=seq(0,tmax,tstep), 
                    R=rep(0, length(seq(0,tmax,tstep))),
                    P1=rep(0, length(seq(0,tmax,tstep))),
                    P2=rep(0, length(seq(0,tmax,tstep))))
                    
  sim[1,2:4] <- c(R,P1,P2)
  
  ## start the algorithm
  while (t < tmax & (P1+P2) > 0) {
    ## compute rates
    rates <- c(theta, ## add resource = 1
               chi*R, ## host resource use = 2
               alpha1*R/(eta1+R)*P1, ## strain 1 resource consumption = 3
               alpha2*R/(eta2+R)*P2, ## strain 2 resource consumption = 4
               epsilon1*alpha1*R/(eta1+R)*P1, ## strain 1 replication = 5
               epsilon2*alpha2*R/(eta2+R)*P2, ## strain 2 replication = 6
               delta1*P1, ## strain 1 death = 7
               delta2*P2, ## strain 2 death = 8
               mu*P1, ## strain 1 mutating to strain 2 = 9
               mu*P2) ## strain 2 mutating to strain 1 = 10
   
    ## what time does the event happen?
    dt <- rexp(1, rate=sum(rates))
    
    ## if these are not equal, don't record anything
    if(max(which(t >= seq(0,tmax,tstep)))!=max(which(t+dt > seq(0,tmax,tstep))))
      sim[max(which(t+dt > seq(0,tmax,tstep))), 2:4] <- c(R, P1, P2)
    
    ## update t 
    t <- t + dt
    
    ## "wheel of fortune"
    wheel <- cumsum(rates)/sum(rates)
    
    ## which event happens? Draw a random uniform to determine
    rand <- runif(1)
    event <- 1 + sum(rand > wheel)
    if (event==1) R <- R + 1
    else if (event%in%2:4) R <- R - 1
    else if (event==5) P1 <- P1 + 1
    else if (event==6) P2 <- P2 + 1
    else if (event==7) P1 <- P1 - 1
    else if (event==8) P2 <- P2 - 1
    else if (event==9) { P1 <- P1 -1; P2 <- P2 + 1}
    else {P1 <- P1 + 1; P2 <- P2 - 1}
      
  }
  return(sim)
}

## Deterministic version of the model
deterministic_strain_competition <- function(t, y0, pars) {
  theta <- pars["theta"]
  chi <- pars["chi"]
  alpha1 <- pars["alpha1"]
  alpha2 <- pars["alpha2"]
  eta1 <- pars["eta1"]
  eta2 <- pars["eta2"]
  epsilon1 <- pars["epsilon1"]
  epsilon2 <- pars["epsilon2"]
  delta1 <- pars["delta1"]
  delta2 <- pars["delta2"]
  mu <- pars["mu"]
  
  R <- y0["R"]
  P1 <- y0["P1"]
  P2 <- y0["P2"]
  b <- pars["b"]
  bs <- pars["bs"]
  d <- pars["d"]
  ds <- pars["ds"]
  
  dRdt <- theta - chi*R - alpha1*R/(eta1+R)*P1 - alpha1*R/(eta1+R)*P2
  dP1dt <- epsilon1*alpha1*R/(eta1+R)*P1 - delta1*P1 - mu*P1 + mu*P2
  dP2dt <- epsilon2*alpha2*R/(eta2+R)*P2 - delta2*P2 - mu*P2 + mu*P1
  
  return(list(c(dRdt,dP1dt,dP2dt)))
}

library(deSolve)
library(parallel)
library(magrittr)

det_sim <- ode(y = y0, times=seq(0,100,0.1), func=deterministic_strain_competition, parms=pars)

```

```{r fig1, fig.height=4, fig.width=6, fig.cap="Dynamics of resources and each pathogen strain when resource competition is fairly similar between the two strains. For this set of parameters, the strain 1-only resource equilibrium is 52.6, and the strain 2-only resoure equilibrim is 58.8. In the absence of parasites, the equilibrium is 100. The mutation rate is fairly high, 0.01."}

## choose parameters appropriately so that strain 1 can persist and outcompete strain 2
pars <- c(theta=10, chi=0.1, alpha1=1, alpha2=0.9, eta1=1000, eta2=1000, epsilon1=20, epsilon2=20, delta1=1, delta2=1, mu=0.01)
# ## resource abundance in the absence of parasites
# pars["theta"]/pars["chi"]
# ## resource abundance with strain 1
# R1 <- pars["eta1"]*pars["delta1"]/(pars["epsilon1"]*pars["alpha1"]-pars["delta1"])
# ## strain 1 outcompetes strain 2 if this is smaller than the above
# R2 <- pars["eta2"]*pars["delta2"]/(pars["epsilon2"]*pars["alpha2"]-pars["delta2"])
# ## strain 1 abundance at equilibrium in the absence of mutation
# -(((pars["eta1"] + R1)*(pars["chi"]*R1 - pars["theta"]))/(pars["alpha1"]*R1))

## Set the initial conditions
y0 <- c(R = 100, P1 = 10, P2 = 0)

## Do some stochastic simulations
set.seed(1234)
seeds <- floor(runif(24, 1, 1e5))
mclapply(seeds,
         function(s) stochastic_strain_competition(100, tstep=0.1, pars=pars, y0=y0, seed=s),
         mc.cores=4) -> stoch_sims

par(mfrow=c(1,3))
for (j in 2:4) {
  plot.new()
  plot.window(xlim=range(stoch_sims[[1]][,1]), ylim=c(0, lapply(stoch_sims, function(s) max(s[,j])) %>% unlist %>% max))
  axis(1); axis(2); box('plot')
  for (i in 1:length(stoch_sims)) lines(stoch_sims[[i]][,1], stoch_sims[[i]][,j], col=gray(0.5))
  lines(stoch_sims[[1]][,1], lapply(stoch_sims, function(s) s[,j]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean), col=1, lwd=2)
}


```

```{r fig2, fig.height=4, fig.width=6, fig.cap="Dynamics of resources and each pathogen strain when resource competition is more biased towards strain 1. For this set of parameters, the strain 1-only resource equilibrium is 52.6, and the strain 2-only resoure equilibrim is 76.9. In the absence of parasites, the equilibrium is 100. The mutation rate is fairly high, 0.01. This change makes the mutant strain much rarer, as it tends to be outcompeted fairly quickly."}

## choose parameters appropriately so that strain 1 can persist and outcompete strain 2
pars <- c(theta=10, chi=0.1, alpha1=1, alpha2=0.7, eta1=1000, eta2=1000, epsilon1=20, epsilon2=20, delta1=1, delta2=1, mu=0.01)
# ## resource abundance in the absence of parasites
# pars["theta"]/pars["chi"]
# ## resource abundance with strain 1
# R1 <- pars["eta1"]*pars["delta1"]/(pars["epsilon1"]*pars["alpha1"]-pars["delta1"])
# ## strain 1 outcompetes strain 2 if this is smaller than the above
# R2 <- pars["eta2"]*pars["delta2"]/(pars["epsilon2"]*pars["alpha2"]-pars["delta2"])
# ## strain 1 abundance at equilibrium in the absence of mutation
# -(((pars["eta1"] + R1)*(pars["chi"]*R1 - pars["theta"]))/(pars["alpha1"]*R1))

## Set the initial conditions
y0 <- c(R = 100, P1 = 10, P2 = 0)

## Do some stochastic simulations
set.seed(1234)
seeds <- floor(runif(24, 1, 1e5))
mclapply(seeds,
         function(s) stochastic_strain_competition(100, tstep=0.1, pars=pars, y0=y0, seed=s),
         mc.cores=4) -> stoch_sims

par(mfrow=c(1,3))
for (j in 2:4) {
  plot.new()
  plot.window(xlim=range(stoch_sims[[1]][,1]), ylim=c(0, lapply(stoch_sims, function(s) max(s[,j])) %>% unlist %>% max))
  axis(1); axis(2); box('plot')
  for (i in 1:length(stoch_sims)) lines(stoch_sims[[i]][,1], stoch_sims[[i]][,j], col=gray(0.5))
  lines(stoch_sims[[1]][,1], lapply(stoch_sims, function(s) s[,j]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean), col=1, lwd=2)
}


```

```{r fig3, fig.height=4, fig.width=6, fig.cap="This is the same set of parameters as in the preceding simulation, except that the mutation rate is much lower, 0.001. Now the mutant essentially cannot persist."}

## choose parameters appropriately so that strain 1 can persist and outcompete strain 2
pars <- c(theta=10, chi=0.1, alpha1=1, alpha2=0.7, eta1=1000, eta2=1000, epsilon1=20, epsilon2=20, delta1=1, delta2=1, mu=0.001)
# ## resource abundance in the absence of parasites
# pars["theta"]/pars["chi"]
# ## resource abundance with strain 1
# R1 <- pars["eta1"]*pars["delta1"]/(pars["epsilon1"]*pars["alpha1"]-pars["delta1"])
# ## strain 1 outcompetes strain 2 if this is smaller than the above
# R2 <- pars["eta2"]*pars["delta2"]/(pars["epsilon2"]*pars["alpha2"]-pars["delta2"])
# ## strain 1 abundance at equilibrium in the absence of mutation
# -(((pars["eta1"] + R1)*(pars["chi"]*R1 - pars["theta"]))/(pars["alpha1"]*R1))

## Set the initial conditions
y0 <- c(R = 100, P1 = 10, P2 = 0)

## Do some stochastic simulations
set.seed(1234)
seeds <- floor(runif(24, 1, 1e5))
mclapply(seeds,
         function(s) stochastic_strain_competition(100, tstep=0.1, pars=pars, y0=y0, seed=s),
         mc.cores=4) -> stoch_sims

par(mfrow=c(1,3))
for (j in 2:4) {
  plot.new()
  plot.window(xlim=range(stoch_sims[[1]][,1]), ylim=c(0, lapply(stoch_sims, function(s) max(s[,j])) %>% unlist %>% max))
  axis(1); axis(2); box('plot')
  for (i in 1:length(stoch_sims)) lines(stoch_sims[[i]][,1], stoch_sims[[i]][,j], col=gray(0.5))
  lines(stoch_sims[[1]][,1], lapply(stoch_sims, function(s) s[,j]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean), col=1, lwd=2)
}


```

How does anorexia affect these results? We can explore that by varying the value of $\theta$ and asking how that affects the abundances of both strains at equilibrium.

```{r fig3, fig.height=4, fig.width=6, fig.cap=""}

## Vary theta and record the mean trajectories only
Rresults <- P1results <- P2results <- c()
for (th in 8:12) {
  pars <- c(theta=th, chi=0.1, alpha1=1, alpha2=0.7, eta1=1000, eta2=1000, epsilon1=20, epsilon2=20, delta1=1, delta2=1, mu=0.001)
  set.seed(1234)
  seeds <- floor(runif(24, 1, 1e5))
  mclapply(seeds,
           function(s) stochastic_strain_competition(100, tstep=0.1, pars=pars, y0=y0, seed=s),
           mc.cores=4) -> stoch_sims
  Rresults <- cbind(Rresults,
                   lapply(stoch_sims, function(s) s[,2]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean))
  P1results <- cbind(P1results,
                   lapply(stoch_sims, function(s) s[,3]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean))
  P2results <- cbind(P2results,
                   lapply(stoch_sims, function(s) s[,4]) %>% do.call(cbind.data.frame, .) %>% apply(., 1, mean))
  print(th)
}
```
  
Key thing to note here: increasing ingestion increases the abundance of strain 1, but not strain 2 in the absence of drugs. 
This is the key thing to keep in mind... anorexia will reduce the likelihood of emergence by reducing the abundance of the drug-susceptible strain.
